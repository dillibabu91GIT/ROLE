name: IBPS-warfileinstall
run-name: IBPS-warfileinstall-${{ github.event.inputs.release_version }}

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version to deploy'
        required: true 
        type: string
      war_file_path:
        description: 'Path to the WAR file on the target server'
        required: true
        type: string
        default: '/ibm/IBM/WebSphere/AppServer/profiles/AppSrv01/installedApps/antibpsapp1Cell01/KYC_Remediation.war'
      war_file_name:
        description: 'Name of the WAR file'
        required: true
        type: string
        default: 'KYC_Remediation.war'
      app_name:
        description: 'Name of the deployed application'
        required: true
        type: string
        default: 'KYC_Remediation_war'
      context_root:
        description: 'Context root of the deployed application'
        required: true
        type: string
        default: '/KYC_Remediation'

jobs:
  deploy:
    runs-on:
      group: rakbank-self-hosted-runner
      labels: [dehitdevtra1]

    steps:
    - name: Checkout mcf_db repository
      uses: actions/checkout@v4
      with:
        repository: rakbank-internal/mcf_db
        ref: ${{ github.event.inputs.branch }}
      
    - name: Checkout enterprise-ansible-roles repository
      uses: actions/checkout@v4
      with:
        repository: rakbank-internal/enterprise-ansible-roles
        token: ${{ secrets.TOKEN_GITHUB }}
        path: ansible-roles
        ref: Feature

    - name: Debug Working Directory
      run: |
        ls -al
        pwd
        
    - name: Make war-install-in-was.sh executable
      run: chmod +x war-install-in-was.sh
  
    - name: Run Ansible Playbook
      env:
        TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
        release_version: ${{ github.event.inputs.release_version }}
        war_file_path: ${{ github.event.inputs.war_file_path }}
        war_file_name: ${{ github.event.inputs.war_file_name }}
        app_name: ${{ github.event.inputs.app_name }}
        context_root: ${{ github.event.inputs.context_root }}
      run: |
        cd ${{ github.workspace }}
        ansible-playbook -vvv -b --extra-vars "target=target_wasuat209 destination=${{ github.workspace }} release_version=${{ env.release_version }} war_file_path=${{ env.war_file_path }} war_file_name=${{ env.war_file_name }} app_name=${{ env.app_name }} context_root=${{ env.context_root }}" ./playbook/IBPS-warfileinstall.yml
        # Uncomment and modify the lines below to run the playbook on additional targets
        # ansible-playbook -vvv -b --extra-vars "target=target_wasuat210 destination=${{ github.workspace }} release_version=${{ env.release_version }} war_file_path=${{ env.war_file_path }} war_file_name=${{ env.war_file_name }} app_name=${{ env.app_name }} context_root=${{ env.context_root }}" ./playbook/IBPS-warfileinstall.yml
        # ansible-playbook -vvv -b --extra-vars "target=target_wasreplica86 destination=${{ github.workspace }} release_version=${{ env.release_version }} war_file_path=${{ env.war_file_path }} war_file_name=${{ env.war_file_name }} app_name=${{ env.app_name }} context_root=${{ env.context_root }}" ./playbook/IBPS-warfileinstall.yml
---------------------------------

name: IBPS-loose-file-deployment
run-name: IBPS-loose-file-deployment-${{ github.event.inputs.release_version }}
on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version to deploy'
        required: true 
        type: string
      tag:
        description: 'Release tag name'
        required: true
        type: string
      fileName:
        description: 'Release file name'
        required: true
        type: string
      deploy_mode:
        description: 'Deploy loose file'
        required: true
        type: string
        default: 'false'
      rollback_mode:
        description: 'Rollback loose file'
        required: true
        type: string
        default: 'false'

jobs:
  deploy:
    runs-on:
      group: rakbank-self-hosted-runner
      labels: [dehitdevtra1]

    steps:
    - name: Checkout mcf_db repository
      uses: actions/checkout@v4
      with:
        repository: rakbank-internal/mcf_db
        ref: ${{ github.event.inputs.branch }}
      
    - name: Checkout enterprise-ansible-roles repository
      uses: actions/checkout@v4
      with:
        repository: rakbank-internal/enterprise-ansible-roles
        token: ${{ secrets.TOKEN_GITHUB }}
        path: ansible-roles
        ref: Feature

    - name: Debug Working Directory
      run: |
        ls -al
        pwd

    - name: Make deploy.sh and rollback.sh executable
      run: |
        chmod +x deploy.sh rollback.sh

    - name: Download IBPS Release
      uses: robinraju/release-downloader@v1.9
      id: download_release
      with:
        repository: rakbank-internal/ibps-was-ansible-cd
        tag: ${{ github.event.inputs.tag }}
        fileName: ${{ github.event.inputs.fileName }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Set downloaded file URL as an environment variable
      run: echo "ZIP_FILE_URL=${{ github.workspace }}/${{ github.event.inputs.fileName }}" >> $GITHUB_ENV

    - name: Display ZIP_FILE_URL
      run: echo $ZIP_FILE_URL

    - name: Run Ansible Playbook
      env:
        TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
        release_version: ${{ github.event.inputs.release_version }}
        deploy_mode: ${{ github.event.inputs.deploy_mode }}
        rollback_mode: ${{ github.event.inputs.rollback_mode }}
      run: |
        cd ${{ github.workspace }}
        ansible-playbook -vvv -b --extra-vars "target=target_wasuat209 destination=${{ github.workspace }} deploy_mode=${{ env.deploy_mode }} rollback_mode=${{ env.rollback_mode }} release_version=${{ env.release_version }}" ./playbook/IBPS-loose-file-deployment.yml
        # Uncomment and modify the lines below to run the playbook on additional targets
        # ansible-playbook -vvv -b --extra-vars "target=target_wasuat210 destination=${{ github.workspace }} deploy_mode=${{ env.deploy_mode }} rollback_mode=${{ env.rollback_mode }} release_version=${{ env.release_version }}" ./playbook/IBPS-loose-file-deployment.yml
        # ansible-playbook -vvv -b --extra-vars "target=target_wasreplica86 destination=${{ github.workspace }} deploy_mode=${{ env.deploy_mode }} rollback_mode=${{ env.rollback_mode }} release_version=${{ env.release_version }}" ./playbook/IBPS-loose-file-deployment.yml
