rakbank-internal/RetailOnboarding-DB/.github/workflows/main.yml@refs/heads/RETAIL-DB-ROLE
rakbank-internal/SMEDigitalBank-DB/.github/workflows/main.yml@refs/heads/SME-DB-ROLE


name: Deploy Database
on:
  workflow_dispatch:
    inputs:
      compile_date:
        description: 'Compile date to deploy'
        required: true
        type: string

jobs:
  deploy:
    runs-on: 
      group: rakbank-self-hosted-runner
      labels: dehitdevtra1
    steps:
      - name: Checkout mcf_db repository
        uses: actions/checkout@v4
        with:
          repository: rakbank-internal/mcf_db
          ref: ${{ github.event.inputs.branch }}

      - name: Checkout enterprise-ansible-roles repository
        uses: actions/checkout@v4
        with:
          repository: rakbank-internal/enterprise-ansible-roles
          token: ${{ secrets.TOKEN_GITHUB }}
          path: ansible-roles
          ref: gh-pages  

      - name: Debug Working Directory
        run: |
          ls -al
          pwd

      - name: Run Ansible Playbook
        env:
          TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
          ORA_USERNAME: ${{ secrets.ORA_USERNAME }}
          ORA_PASSWORD: ${{ secrets.ORA_PASSWORD }}
          COMPILE_DATE: ${{ github.event.inputs.compile_date }}
        run: |
          cd ${{ github.workspace }}
          ansible-playbook -vvv -b -i inventory.ini ./playbook/mcfdbdeployment.yml --extra-vars "oracle_host=10.15.25.168:5300 github_token=${{ secrets.TOKEN_GITHUB }} owner=rakbank-internal repo=mcf_db branch=RELEASE-DB-ROLE username=${{ secrets.ORA_USERNAME }} password=${{ secrets.ORA_PASSWORD }} ORACLE_SID=CNVDGUAT compile_date=${{ github.event.inputs.compile_date }} ORACLE_HOME=/oracle19c/app/oracle/product/19.3.0/db_home PATH=/oracle19c/app/oracle/product/19.3.0/db_home/bin:/usr/bin oracle_deployment_dir=/backup destination=${{ github.workspace }}"


-----------------------

---
oracle_host: "{{ oracle_host }}"
github_token: "{{ github_token }}"
owner: "{{ owner }}"
repo: "{{ repo }}"
branch: "{{ branch }}"
username: "{{ username }}"
password: "{{ password }}"
ORACLE_SID: "{{ ORACLE_SID }}"
zip_file_name: "/ansible/UAT_ARTIFACTS/UAT4/{{ compile_date }}/RAK_IB_CONVERGENCE_PATCHES_CR_UAT4/DB_SQL"
ORACLE_HOME: "{{ ORACLE_HOME }}"
PATH: "{{ PATH }}"
oracle_deployment_dir: "{{ oracle_deployment_dir }}"

-------------
 - name: Deploy Database
  hosts: oracle_servers
  become: yes
  become_user: itdevtra

  tasks:
    - name: Include sme-retail-deploy-role
      include_role:
        name: sme-retail-deploy-role
        tasks_from: main-deploy.yml
      vars:
        oracle_host: "10.15.25.168:5300"
        github_token: "{{ lookup('env', 'TOKEN_GITHUB') }}"
        owner: "rakbank-internal"
        repo: "SMEDigitalBank-DB"
        branch: "SME-DB-ROLE"
        username: "{{ lookup('env', 'ORA_USERNAME') }}"
        password: "{{ lookup('env', 'ORA_PASSWORD') }}"
        ORACLE_SID: "CNVDGUAT"
        zip_file_url: "https://maven.pkg.github.com/rakbank-internal/SMEDigitalBank-DB/com/rakbank/infosys/lib/smedigitalbank-database/deploy-sql/{{ lookup('env', 'RELEASE_VERSION') }}/deploy-sql-{{ lookup('env', 'RELEASE_VERSION') }}.zip"
        zip_file_name: "{{ zip_file_url | basename }}"
        zip_file_url_1: "https://maven.pkg.github.com/rakbank-internal/SMEDigitalBank-DB/com/rakbank/infosys/lib/smedigitalbank-database/dbscript/{{ lookup('env', 'RELEASE_VERSION') }}/dbscript-{{ lookup('env', 'RELEASE_VERSION') }}.zip"
        zip_file_name_1: "{{ zip_file_url_1 | basename }}"
        zip_file_url_2: "https://maven.pkg.github.com/rakbank-internal/SMEDigitalBank-DB/com/rakbank/infosys/lib/smedigitalbank-database/rollback-sql/{{ lookup('env', 'RELEASE_VERSION') }}/rollback-sql-{{ lookup('env', 'RELEASE_VERSION') }}.zip"
        zip_file_name_2: "{{ zip_file_url_2 | basename }}"
        ORACLE_HOME: "/oracle19c/app/oracle/product/19.3.0/db_home"
        PATH: "{{ ORACLE_HOME }}/bin:{{ PATH }}"
        oracle_deployment_dir: "/backup"
-------------------
Run cd /ansible/GITHUB_RUNNER/actions-runner10/_work/SMEDigitalBank-DB/SMEDigitalBank-DB
ansible-playbook 2.8.18
  config file = /ansible/GITHUB_RUNNER/actions-runner10/_work/SMEDigitalBank-DB/SMEDigitalBank-DB/ansible.cfg
  configured module search path = ['/home/itdevtra/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python3.6/site-packages/ansible
  executable location = /usr/bin/ansible-playbook
  python version = 3.6.8 (default, Jan 14 2022, 11:04:20) [GCC 8.5.0 20210514 (Red Hat 8.5.0-7)]
Using /ansible/GITHUB_RUNNER/actions-runner10/_work/SMEDigitalBank-DB/SMEDigitalBank-DB/ansible.cfg as config file
host_list declined parsing /ansible/GITHUB_RUNNER/actions-runner10/_work/SMEDigitalBank-DB/SMEDigitalBank-DB/inventory.text as it did not pass it's verify_file() method
script declined parsing /ansible/GITHUB_RUNNER/actions-runner10/_work/SMEDigitalBank-DB/SMEDigitalBank-DB/inventory.text as it did not pass it's verify_file() method
auto declined parsing /ansible/GITHUB_RUNNER/actions-runner10/_work/SMEDigitalBank-DB/SMEDigitalBank-DB/inventory.text as it did not pass it's verify_file() method
yaml declined parsing /ansible/GITHUB_RUNNER/actions-runner10/_work/SMEDigitalBank-DB/SMEDigitalBank-DB/inventory.text as it did not pass it's verify_file() method
Parsed /ansible/GITHUB_RUNNER/actions-runner10/_work/SMEDigitalBank-DB/SMEDigitalBank-DB/inventory.text inventory source with ini plugin
ERROR! Syntax Error while loading YAML.
  did not find expected '-' indicator

The error appears to be in '/ansible/GITHUB_RUNNER/actions-runner10/_work/SMEDigitalBank-DB/SMEDigitalBank-DB/playbook/smedbdeployment.yml': line 2, column 3, but may
be elsewhere in the file depending on the exact syntax problem.

The offending line appears to be:

 - name: Deploy Database
  hosts: oracle_servers
  ^ here
Error: Process completed with exit code 4.
