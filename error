name: Deploy Database

on:
  workflow_dispatch:
    inputs:
      compile_date:
        description: 'Compile date to deploy'
        required: true
        type: string

jobs:
  deploy:
    runs-on: 
      group: rakbank-self-hosted-runner
      labels: dehitdevtra1

    steps:
      - name: Install Git
        run: |
          if ! command -v git &> /dev/null
          then
            echo "Git not found, installing..."
            sudo apt-get update
            sudo apt-get install -y git
          else
            echo "Git is already installed."
          fi

      - name: Checkout mcf_db repository
        uses: actions/checkout@v2
        with:
          repository: rakbank-internal/mcf_db
          ref: ${{ github.event.inputs.branch }}

      - name: Clone enterprise-ansible-roles repository
        run: |
          if [ ! -d "../enterprise-ansible-roles" ]; then
            git clone https://github.com/rakbank-internal/enterprise-ansible-roles ../enterprise-ansible-roles
          else
            echo "Directory ../enterprise-ansible-roles already exists."
          fi

      - name: Debug Working Directory
        run: |
          ls -al
          pwd

      - name: Run Ansible Playbook
        env:
          TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
          ORA_USERNAME: ${{ secrets.ORA_USERNAME }}
          ORA_PASSWORD: ${{ secrets.ORA_PASSWORD }}
          COMPILE_DATE: ${{ github.event.inputs.compile_date }}
        run: |
          cd ${{ github.workspace }}
          ansible-playbook -vvv -b -i inventory.ini ./playbook/mcfdbdeployment.yml --extra-vars "target=oracle_servers destination=${{ github.workspace }}"

